<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WHEEL TECH BICYCLIG — Promoções</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f8fb; margin:20px; }
    header { background: linear-gradient(90deg,#0b66c2,#0ba66c); color:white; padding:18px; border-radius:10px; }
    h1 { margin:0; }
    .card { background:white; padding:12px; margin-top:14px; border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);}
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th,td { padding:8px; border-bottom: 1px solid #eee; text-align:left; font-size:13px;}
    th { background:#eaf4ff; color:#083d66;}
    .badge { display:inline-block; padding:4px 8px; border-radius:6px; font-weight:600; color:white; }
    .started{ background:#0b66c2; } .candidate{ background:#0ba66c; }
    .alert-row{ background:#ffecec; }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:none; font-weight:600; }
    .btn-primary{ background:#0b66c2; color:white; } .btn-green{ background:#0ba66c; color:white; }
    input{ padding:8px; border-radius:8px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <header>
    <h1>WHEEL TECH BICYCLIG — Painel de Promoções</h1>
  </header>

  <div class="card" id="loginCard">
    <h3>Acesso</h3>
    <div class="controls">
      <input id="username" placeholder="Usuário (ex: RONALD)" value="RONALD" />
      <input id="password" placeholder="Senha" type="password" value="2101" />
      <button class="btn btn-primary" id="btnLogin">Entrar</button>
      <span id="loginMsg"></span>
    </div>
  </div>

  <div class="card" id="mainCard" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <strong>Usuário:</strong> <span id="userNameTxt"></span>
      </div>
      <div>
        <button class="btn btn-green" id="btnRefresh">Atualizar</button>
        <button class="btn" id="btnExport">Exportar XLSX</button>
      </div>
    </div>

    <h3>Promoções</h3>
    <table id="tbl">
      <thead>
        <tr>
          <th>item_id</th><th>promotion_name</th><th>status</th><th>price</th><th>max_discounted_price</th><th>moeda</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Alertas / Divergências</h3>
    <ul id="alerts"></ul>
  </div>

<script>
const API_BASE = "https://SEU_BACKEND.onrender.com"; // <- substituir pela URL real do backend
let token = localStorage.getItem("wt_token");

function showMsg(el, msg){ el.textContent = msg; setTimeout(()=>el.textContent="",4000); }

async function doLogin(){
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const res = await fetch(API_BASE + "/api/login", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username: u, password: p})
  });
  if (res.ok){
    const j = await res.json();
    token = j.token;
    localStorage.setItem("wt_token", token);
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("mainCard").style.display = "block";
    document.getElementById("userNameTxt").textContent = u;
    await loadData();
  } else {
    showMsg(document.getElementById("loginMsg"), "Credenciais inválidas");
  }
}

async function loadData(){
  const res = await fetch(API_BASE + "/api/promotions", { headers: {"Authorization":"Bearer " + token} });
  if (!res.ok) { alert("Erro ao carregar dados (verifique backend)"); return; }
  const j = await res.json();
  const data = j.data || [];
  const alerts = j.alerts || [];
  const tbody = document.querySelector("#tbl tbody"); tbody.innerHTML = "";
  data.forEach(row=>{
    const tr = document.createElement("tr");
    if (row.status === "candidate" && alerts.find(a=>a.item_id===row.item_id)) tr.classList.add("alert-row");
    tr.innerHTML = `
      <td>${row.item_id}</td>
      <td>${row.promotion_name}</td>
      <td><span class="badge ${row.status==='started'?'started':'candidate'}">${row.status}</span></td>
      <td>${row.price}</td>
      <td>${row.max_discounted_price}</td>
      <td>${row.moeda||""}</td>
    `;
    tbody.appendChild(tr);
  });

  const alertsEl = document.getElementById("alerts");
  alertsEl.innerHTML = "";
  if ((j.divergencias||[]).length === 0) alertsEl.innerHTML = "<li>Sem divergências</li>";
  else {
    (j.divergencias||[]).forEach(iid=>{
      const li = document.createElement("li");
      li.textContent = iid;
      alertsEl.appendChild(li);
    });
  }
}

document.getElementById("btnLogin").addEventListener("click", doLogin);
document.getElementById("btnRefresh").addEventListener("click", loadData);
document.getElementById("btnExport").addEventListener("click", async ()=>{
  const res = await fetch(API_BASE + "/api/download", { headers: {"Authorization":"Bearer " + token} });
  if (!res.ok){ alert("Erro ao gerar XLSX"); return; }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "relatorio_promos.xlsx";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// se já tem token, auto login
if (token){
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("mainCard").style.display = "block";
  document.getElementById("userNameTxt").textContent = "RONALD";
  loadData();
}
</script>
</body>
</html>

